# =====================================
# Telegraf Configuration for MQTT â†’ InfluxDB
# =====================================

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  flush_interval = "10s"
  flush_jitter = "0s"
  collection_jitter = "0s"
  precision = ""
  omit_hostname = true

# =====================================
# INPUT PLUGIN: MQTT Consumer
# =====================================
[[inputs.mqtt_consumer]]
  ## MQTT broker (update if needed)
  servers = ["tcp://emqx:1883"]

  ## Subscribe to all factory device telemetry topics
  topics = [
    "factory/+/+/telemetry"
  ]

  ## Extract MQTT topic as a tag for context
  topic_tag = "topic"

  ## Connection settings
  qos = 1
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false

  ## Client ID for Telegraf
  client_id = "telegraf-mqtt-simulator-listener"
  username = ""
  password = ""

  ## JSON payload format
  data_format = "json"

  ## Your simulator sends: { "timestamp", "value", "client_id" }
  json_time_key = "timestamp"
  json_time_format = "2006-01-02T15:04:05Z07:00"

  ## Use the client_id field as measurement name
  json_name_key = "client_id"

  ## Tags and fields
  tag_keys = ["client_id"]
  json_string_fields = ["client_id"]
  json_query = ""

# =====================================
# OUTPUT PLUGIN: InfluxDB v2
# =====================================
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "iot-admin-token-123"
  organization = "iot-org"
  bucket = "iot-data"

  timeout = "5s"
  content_encoding = "gzip"

# =====================================
# (Optional) System Metrics (for debugging)
# =====================================
#[[inputs.cpu]]
#  percpu = true
#  totalcpu = true

#[[inputs.mem]]
#[[inputs.disk]]
#[[inputs.diskio]]
#[[inputs.net]]

# =====================================
# Logging Output (debugging)
# =====================================
[[outputs.file]]
  files = ["stdout"]
  data_format = "json"
